import numpy as np
from src.AOD.CRA_LICOM.Configure.DefaultConfig import Config
import calendar
from src.AOD.CRA_LICOM.Configure.LoadSH import AOD_GFZ,AODtype
from tqdm import tqdm
from src.AOD.CRA_LICOM.Configure.Format import FormatWrite,CnmSnm
from datetime import datetime,timedelta

class MonthMean(Config):
    def __init__(self):
        super().__init__()
        self.Month = 12
        self.begin_dates =['2013001','2013032','2013101','2013121','2013152','2013182','2013274','2013305','2013335',
                           '2014001','2014062','2014091','2014121','2014152','2014213','2014244','2014274','2014305',
                           '2015013','2015032','2015060','2015091','2015102','2015180','2015213','2015244','2015345',
                           '2016004','2016029','2016061','2016129','2016153','2016183','2016221','2016319','2016346',
                           '2017007','2017076','2017100','2017123','2017143',]
        self.begin_gfo = ['2018152','2018182','2018295','2018305','2018335',
                          '2019001','2019026','2019060','2019091','2019121','2019152','2019182','2019213','2019244','2019274','2019305','2019335',
                          '2020001','2020032','2020061','2020092','2020122','2020153','2020183','2020214','2020245','2020275','2020306','2020336',
                          '2021001','2021032','2021060','2021091','2021121','2021152','2021182','2021213','2021244','2021274','2021305','2021335',
                          '2022001','2022032','2022060','2022091','2022121','2022152','2022182','2022213','2022244','2022274','2022305','2022335',
                          '2023001','2023032','2023060','2023091','2023121','2023152','2023182','2023213','2023244','2023274','2023305','2023335',]


        self.end_dates = ['2013031','2013057','2013120','2013151','2013181','2013212','2013304','2013334','2013365',
                          '2014016','2014090','2014120','2014151','2014175','2014243','2014273','2014304','2014334',
                          '2015031','2015059','2015090','2015120','2015131','2015212','2015243','2015270','2016003',
                          '2016028','2016060','2016091','2016152','2016182','2016211','2016247','2016345','2017006',
                          '2017034','2017104','2017128','2017142','2017179']
        self.end_gfo = ['2018181','2018199','2018313','2018334','2018365',
                        '2019031','2019066','2019090','2019120','2019151','2019181','2019212','2019243','2019273','2019304','2019334','2019365',
                        '2020031','2020060','2020091','2020121','2020152','2020182','2020213','2020244','2020274','2020305','2020335','2020366',
                        '2021031','2021059','2021090','2021120','2021151','2021181','2021212','2021243','2021273','2021304','2021334','2021365',
                        '2022031','2022059','2022090','2022120','2022151','2022181','2022212','2022243','2022273','2022304','2022334','2022365',
                        '2023031','2023059','2023090','2023120','2023151','2023181','2023212','2023243','2023273','2023304','2023334','2023365']
        self.begin = ['2024001','2024032','2024061','2024092']
        self.end = ['2024031','2024060','2024091','2024121']

    def GetMonth(self,year='2002'):
        for month in tqdm(np.arange(1,self.Month+1)):
            day = calendar.monthrange(int(year),month)[1]
            BeginDate = f'{int(year):04d}-{int(month):02d}-{int(1):02d}'
            EndDate = f'{int(year):04d}-{int(month):02d}-{int(day):02d}'
            # print(BeginDate,EndDate)
            daylist = MonthMean().setDuration(BeginDate,EndDate).daylist
            CS_temp = []
            for date in daylist:
                date = date.strftime('%Y-%m-%d')
                # print(date)
                for time in self.TimeEpoch:
                    CS = AOD_GFZ().load(self.Path).setType(AODtype.ATM).setTime(date,time).getCS(Nmax=180)
                    CS = np.array(CS)
                    CS_temp.append(CS)
            CS_temp = np.array(CS_temp)
            CS_mean = np.mean(CS_temp,axis=0)
            fm = FormatWrite().setRootDir(self.SavePath)
            cs_file = CnmSnm(date=BeginDate,Nmax=180)
            cs_file.add(Cnm=CS_mean[0],Snm=CS_mean[1],epoch=time,date=BeginDate,
                        attribute=AODtype.ATM.name)
            fm.setCS(cs_file).GRACE_L2B(start=BeginDate,end=EndDate)


        pass

    def Operation(self,kind=AODtype.ATM):
        begdays = self.begin
        enddays = self.end
        # begdays=['2002095','2002122','2002213','2002244','2002274','2002305','2002335',
        #          '2003001','2003032','2003060','2003091','2003121','2003182','2003213','2003244','2003274','2003305','2003335',
        #          '2004001','2004035','2004061','2004092','2004122','2004153','2004183','2004214','2004245','2004275','2004306','2004336',
        #          '2005001','2005032','2005060','2005091','2005121','2005152','2005182','2005213','2005244','2005274','2005305','2005335',
        #          '2006001','2006032','2006060','2006091','2006121','2006152','2006182','2006213','2006244','2006274','2006305','2006335',
        #          '2007001','2007032','2007060','2007091','2007121','2007152','2007182','2007213','2007244','2007274','2007305','2007335',
        #          '2008001','2008032','2008061','2008092','2008122','2008153','2008183','2008214','2008245','2008275','2008306','2008336',
        #          '2009001','2009032','2009060','2009091','2009121','2009152','2009182','2009213','2009244','2009274','2009305','2009335',
        #          '2010001','2010032','2010060','2010091','2010121','2010152','2010182','2010213','2010244','2010274','2010305','2010335',
        #          '2011039','2011060','2011091','2011121','2011186','2011213','2011244','2011274','2011289','2011347',
        #          '2012001','2012032','2012061','2012080','2012153','2012183','2012214','2012245','2012311','2012336',
        #          '2013001', '2013032', '2013101', '2013121', '2013152', '2013182', '2013274', '2013305', '2013335',
        #          '2014001', '2014062', '2014091', '2014121', '2014152', '2014213', '2014244', '2014274', '2014305',
        #          '2015013', '2015032', '2015060', '2015091', '2015102', '2015180', '2015213', '2015244', '2015345',
        #          '2016004', '2016029', '2016061', '2016129', '2016153', '2016183', '2016221', '2016319', '2016346',
        #          '2017007', '2017076', '2017100', '2017123', '2017143',
        #          ]
        #
        # enddays=['2002120','2002137','2002243','2002273','2002304','2002334','2002365',
        #          '2003031','2003059','2003090','2003120','2003141','2003212','2003243','2003273','2003304','2003334','2003365',
        #          '2004013','2004060','2004091','2004121','2004152','2004182','2004213','2004244','2004274','2004305','2004335','2004366',
        #          '2005031','2005059','2005090','2005120','2005151','2005181','2005212','2005243','2005273','2005304','2005334','2005365',
        #          '2006031','2006059','2006090','2006120','2006151','2006181','2006212','2006243','2006273','2006304','2006334','2006365',
        #          '2007031','2007058','2007090','2007120','2007151','2007181','2007212','2007243','2007273','2007304','2007334','2007365',
        #          '2008031','2008060','2008091','2008121','2008152','2008182','2008213','2008244','2008274','2008305','2008335','2008366',
        #          '2009031','2009059','2009090','2009120','2009151','2009181','2009212','2009243','2009273','2009304','2009334','2009365',
        #          '2010031','2010059','2010090','2010120','2010151','2010181','2010212','2010243','2010273','2010304','2010334','2010361',
        #          '2011059','2011090','2011120','2011151','2011212','2011243','2011273','2011304','2011319','2012011',
        #          '2012031','2012060','2012091','2012109','2012182','2012213','2012244','2012269','2012335','2012366',
        #          '2013031', '2013057', '2013120', '2013151', '2013181', '2013212', '2013304', '2013334', '2013365',
        #          '2014016', '2014090', '2014120', '2014151', '2014175', '2014243', '2014273', '2014304', '2014334',
        #          '2015031', '2015059', '2015090', '2015120', '2015131', '2015212', '2015243', '2015270', '2016003',
        #          '2016028', '2016060', '2016091', '2016152', '2016182', '2016211', '2016247', '2016345', '2017006',
        #          '2017034', '2017104', '2017128', '2017142', '2017179',
        #          ]
        for i in np.arange(len(begdays)):
            BeginDate = self.day_of_year_to_date(ordinal=begdays[i])
            EndDate = self.day_of_year_to_date(ordinal=enddays[i])
            print(f'BeginDate is: {self.day_of_year_to_date(ordinal=begdays[i])}')
            print(f'EndDate is: {self.day_of_year_to_date(ordinal=enddays[i])}')
            print(kind.name)
            CS_temp = []
            for date in tqdm(self.setDuration(BeginDate=BeginDate,EndDate=EndDate).daylist):
                date = date.strftime('%Y-%m-%d')
                for time in self.TimeEpoch:
                    CS = AOD_GFZ().load(self.Path).setType(kind).setTime(date, time).getCS(Nmax=180)
                    CS = np.array(CS)
                    CS_temp.append(CS)
            CS_temp = np.array(CS_temp)
            CS_mean = np.mean(CS_temp, axis=0)
            fm = FormatWrite().setRootDir(self.SavePath)
            cs_file = CnmSnm(date=BeginDate, Nmax=180)
            cs_file.add(Cnm=CS_mean[0], Snm=CS_mean[1], epoch=time, date=BeginDate,
                        attribute=kind.name)
            fm.setCS(cs_file).GRACE_L2B(startday=begdays[i], endday=enddays[i],kind=kind.name)


    def date_to_day_of_year(self,year,month,day):
        date = datetime(int(year),int(month),int(day))
        day_of_year = date.timetuple().tm_yday
        return day_of_year

    def day_of_year_to_date(self,ordinal):
        year = int(str(ordinal)[:4])
        day_of_year = int(str(ordinal)[4:])
        date = datetime(year,1,1) + timedelta(days=day_of_year-1)
        return date.strftime('%Y-%m-%d')


def demo1():
    a = MonthMean()
    a.setInterval(interval=6)
    a.setPath(path='I:/CRALICOM/GLO/')
    a.setSavePath(path='I:/CRALICOM/GAA/')
    for year in np.arange(2002,2024):
        a.GetMonth(year=str(year))
def demo2():
    a = MonthMean()
    a.setInterval(interval=6)
    a.setPath(path='I:/CRALICOM/result/Licom_AOD/')
    Save_Names = ['GAA','GAB','GAC','GAD']
    Kinds = [AODtype.ATM,AODtype.OCN,AODtype.GLO,AODtype.OBA]
    for i in np.arange(len(Save_Names)):
        a.setSavePath(path=f'I:/CRALICOM/{Save_Names[i]}/')
        a.Operation(kind=Kinds[i])

def demo3():
    a = MonthMean()
    print(a.day_of_year_to_date(ordinal='2002365'))

if __name__ == '__main__':
    demo2()




